---
title: ë‚´ë¶€ë§ ì—†ì´ ì¸í”„ë¼ ê´€ë¦¬ í™˜ê²½ êµ¬ì¶•í•˜ê¸° (Kubernetes, Keycloak, Oauth2 Proxy, Nginx Ingress)
published: 2025-07-14
tags: [Linux, Cloud, Kubernetes]
category: System
image: ./cover.png
draft: false
---


## ë°°ê²½

ìµœê·¼ ë¶€ëŒ€ ì‚¬ëŒë“¤ê³¼ ê°„ë‹¨í•œ ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©° ì½”ë”© ê³µë¶€ë¥¼ í•˜ê³  ìˆë‹¤. ë§¤ì¼ ì¼ë³¸ì–´ë¥¼ ê³µë¶€í•˜ëŠ” ì…ì¥ì—ì„œ, í¥ë¯¸ë¥¼ ìƒì§€ ì•Šê³  ê¾¸ì¤€íˆ í•™ìŠµí•˜ë ¤ë©´ ì¢‹ì€ ê³µë¶€ ìë£Œê°€ ì¤‘ìš”í•˜ë‹¤ëŠ” ìƒê°ì„ í•˜ê²Œ ë˜ì—ˆë‹¤.
ì´ì— ë‚´ê°€ ì›í•˜ëŠ” ì£¼ì œë¡œ ë§¤ì¼ ê³µë¶€ ìë£Œë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ì„œë¹„ìŠ¤ë¥¼ `LLM`ì„ ì´ìš©í•´ ì§ì ‘ ê°œë°œí•˜ê¸°ë¡œ í–ˆë‹¤.

í•˜ì§€ë§Œ **êµ° ë‚´ë¶€ í™˜ê²½ì—ì„œëŠ” ê°œë°œ, ë°°í¬, ëª¨ë‹ˆí„°ë§ ì¸í”„ë¼ë¥¼ ì•ˆì „í•˜ê²Œ êµ¬ì¶•í•˜ê³  ê´€ë¦¬í•˜ê¸° ì–´ë µë‹¤**ëŠ” í˜„ì‹¤ì ì¸ ë¬¸ì œì— ë¶€ë”ªí˜”ë‹¤. ì›ê²© ì¸í”„ë¼ì— `VPN`ì„ ì—°ê²°í•˜ëŠ” ê²ƒì€ ê·œì •ìƒ ë¶ˆê°€ëŠ¥í–ˆê³ , IP ì£¼ì†Œ ê¸°ë°˜ì˜ ì ‘ê·¼ ì œì–´ëŠ” ê°œë°œ í™˜ê²½ì´ ë°”ë€” ë•Œë§ˆë‹¤ ê·œì¹™ì„ ìƒˆë¡œ ì¶”ê°€í•´ì•¼ í•˜ëŠ” ë²ˆê±°ë¡œì›€ì´ ë”°ëë‹¤. ë³´ë‹¤ ê¹”ë”í•˜ê³  íš¨ìœ¨ì ì¸ ë°©ë²•ì´ í•„ìš”í–ˆë‹¤.

ê³ ë¯¼ ëì— `*.private.sigee.xyz`ì™€ ê°™ì€ **í•˜ìœ„ ë„ë©”ì¸ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒ**ìœ¼ë¡œ ë°©í–¥ì„ ì¡ì•˜ë‹¤. ì´ ë„ë©”ì¸ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ì ‘ì†ì— ëŒ€í•´ **ì¸ì¦ì„ ìš”êµ¬**í•˜ê³ , **ë„ë©”ì¸ë³„ë¡œ ì¸ê°€ëœ ì‚¬ìš©ìë§Œ ì„œë¹„ìŠ¤ì— ì ‘ê·¼**í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒì´ë‹¤.

ë°°í¬ ì¸í”„ë¼ëŠ” `Kubernetes`ë¡œ êµ¬ì¶•í–ˆë‹¤. 4ì½”ì–´ 24GB VM í™˜ê²½ì´ë¼ `Docker` ì‚¬ìš©ë„ ê³ ë ¤í–ˆì§€ë§Œ, ìš”ì¦˜ì€ `MicroK8s`ë‚˜ `K3s`ì²˜ëŸ¼ ì˜ ë§Œë“¤ì–´ì§„ ê²½ëŸ‰ ì¿ ë²„ë„¤í‹°ìŠ¤ ë°°í¬íŒì´ ë§ì•˜ë‹¤. ìµìˆ™í•˜ê²Œ ì‚¬ìš©í•´ì™”ê³  í¸ë¦¬í•œ ëª¨ë“ˆë„ ë§ì´ ì œê³µí•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ë§ˆë‹¤í•  ì´ìœ ê°€ ì—†ì—ˆë‹¤. íŠ¹íˆ `MicroK8s`ëŠ” ëª…ë ¹ì–´ í•˜ë‚˜ë¡œ ëª¨ë“  ì„¤ì¹˜ê°€ ì™„ë£Œë  ì •ë„ë¡œ ê°„í¸í–ˆë‹¤. ê³¼ê±° `kubeadm`ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ë‹¤ ì–´ë ¤ì›€ì„ ê²ªê³  ì§ì ‘ `Ansible` í”Œë ˆì´ë¶ì„ ë§Œë“¤ì–´ ì‚¬ìš©í–ˆë˜ ê²½í—˜ì— ë¹„í•˜ë©´, ì •ë§ ì„¸ìƒì´ ì¢‹ì•„ì¡Œë‹¤ê³  ëŠê¼ˆë‹¤.

`Ubuntu` í™˜ê²½ê³¼ì˜ í˜¸í™˜ì„±ì„ ê³ ë ¤í•˜ì—¬ `MicroK8s`ë¥¼ ìµœì¢… ì„ íƒí–ˆê³ , ê·¸ ìœ„ì— ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ(`Loki`, `Prometheus`, `Grafana`), `ArgoCD`, `Nginx Ingress Controller` ë“±ì„ ì„¤ì¹˜í–ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ ì„œë¹„ìŠ¤ë“¤ì„ ë‚´ë¶€ìš© ë„ë©”ì¸ì— `Ingress`ë¡œ ì—°ê²°í•˜ê³ , `cert-manager`ë¥¼ í†µí•´ `TLS` ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ì•„ `HTTPS` í†µì‹ ê¹Œì§€ ì™„ë£Œí•˜ë©° ê¸°ë³¸ì ì¸ í™˜ê²½ êµ¬ì¶•ì„ ë§ˆì³¤ë‹¤. ì˜ˆì‹œë¡œ ì ì–´ë‘” ë„ë©”ì¸ì€ ì˜ˆì‹œì¼ ë¿ì´ê³ , ì‹¤ì œ ë„ë©”ì¸ ì£¼ì†ŒëŠ” ì´ì™€ ë‹¤ë¥´ë‹¤.

## ì•„í‚¤í…ì²˜

ì´ëŸ¬í•œ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì„±í–ˆë‹¤.

![architecture](./images/architecture.svg)

## êµ¬í˜„ ê³¼ì •

> ğŸ”’ **ì°¸ê³ **: ì•„ë˜ ì„¤ì • íŒŒì¼ì— ë“±ì¥í•˜ëŠ” ì´ë©”ì¼ ì£¼ì†Œ, ë„ë©”ì¸, API í‚¤ ê´€ë ¨ Secret ì´ë¦„ ë“±ì€ ëª¨ë‘ ë³´ì•ˆì„ ìœ„í•´ ì˜ˆì‹œ ê°’ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆë‹¤. ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ìì‹ ì˜ í™˜ê²½ì— ë§ëŠ” ê°’ì„ ì‚¬ìš©í•´ì•¼í•œë‹¤.

### 1. Cert-Manager ì„¤ì •

ê°€ì¥ ë¨¼ì € `Cert-Manager`ë¥¼ ì„¤ì¹˜í•˜ê³  `ClusterIssuer`ë¥¼ ì„¤ì •í–ˆë‹¤. `Cloudflare`ì˜ `DNS01` ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ `Let's Encrypt`ë¡œë¶€í„° ì™€ì¼ë“œì¹´ë“œ ì¸ì¦ì„œ(`*.private.sigee.xyz`)ë¥¼ ë°œê¸‰ë°›ë„ë¡ í–ˆë‹¤. ì´ë¥¼ í†µí•´ `Ingress`ì— `TLS`ë¥¼ ì†ì‰½ê²Œ ì ìš©í•  ìˆ˜ ìˆì—ˆë‹¤.

```yaml
# /cluster-config/base/cert-manager/cluster-issuer.yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-production
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: user@example.com
    privateKeySecretRef:
      name: letsencrypt-production-account-key 
    solvers:
    - dns01:
        cloudflare:
          email: user@example.com
          apiTokenSecretRef:
            name: cloudflare-api-token-secret
            key: api-token
```

### 2. Keycloak ì„¤ì •

ê·¸ ë‹¤ìŒ, `private-keycloak.sigee.xyz` ë„ë©”ì¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ `Keycloak` ì„œë²„ë¥¼ êµ¬ì¶•í–ˆë‹¤. ì—¬ê¸°ì„œëŠ” ì‚¬ìš©ì ê³„ì •, ê·¸ë£¹(`developers` ë“±), ê·¸ë¦¬ê³  `OAuth2-Proxy`ê°€ ì‚¬ìš©í•  `OIDC` í´ë¼ì´ì–¸íŠ¸ë¥¼ ì„¤ì •í–ˆë‹¤. `Keycloak` ìì²´ëŠ” ì™¸ë¶€ì— ì§ì ‘ ë…¸ì¶œë˜ì–´ ë¡œê·¸ì¸ ë° ê³„ì • ê´€ë¦¬ ì—­í• ì„ ìˆ˜í–‰í•œë‹¤.

![Keycloak í´ë¼ì´ì–¸íŠ¸ ì„¤ì •](./images/keycloak-clients.png)
*Keycloakì— ë“±ë¡ëœ OIDC í´ë¼ì´ì–¸íŠ¸ ëª©ë¡*

### 3. OAuth2-Proxy ì„¤ì •

`OAuth2-Proxy`ëŠ” `Keycloak`(`private-keycloak.sigee.xyz`)ê³¼ ì—°ë™ë˜ë„ë¡ ì„¤ì •í–ˆë‹¤. ì¤‘ìš”í•œ ì„¤ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

-   `--oidc-issuer-url`: `Keycloak`ì˜ realmì„ ë°”ë¼ë³´ë„ë¡ ì„¤ì •.
-   `--allowed-group`: `/developers` ê·¸ë£¹ì— ì†í•œ ì‚¬ìš©ìë§Œ ì ‘ê·¼ì„ í—ˆìš©.

```yaml
# /applications/oauth2-proxy/base/deployment.yaml ì¼ë¶€
...
        args:
        - --provider=oidc
        - --oidc-issuer-url=https://private-keycloak.sigee.xyz/realms/master
        - --email-domain=*
        - --cookie-domain=.private.sigee.xyz
        - --allowed-group="/developers"
        - --oidc-groups-claim=groups
...
```

### 4. Ingress ì„¤ì •ìœ¼ë¡œ ëª¨ë“  ê²ƒ ì—°ê²°í•˜ê¸°

ë§ˆì§€ë§‰ìœ¼ë¡œ, ë³´í˜¸í•˜ë ¤ëŠ” ë‚´ë¶€ ì„œë¹„ìŠ¤(`ArgoCD`, `Grafana` ë“±)ì˜ `Ingress` ë¦¬ì†ŒìŠ¤ì— ë‹¤ìŒê³¼ ê°™ì€ ì–´ë…¸í…Œì´ì…˜ì„ ì¶”ê°€í•˜ì—¬ ì¸ì¦ ê³¼ì •ì„ ì™„ì„±í–ˆë‹¤.

```yaml
# /applications/argocd/base/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-ingress
  annotations:
    nginx.ingress.kubernetes.io/auth-url: "https://oauth2.private.sigee.xyz/oauth2/auth"
    nginx.ingress.kubernetes.io/auth-signin: "https://oauth2.private.sigee.xyz/oauth2/start?rd=$scheme://$http_host$request_uri"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
      - argocd.private.sigee.xyz
    secretName: argocd-tls-secret
  rules:
  - host: argocd.private.sigee.xyz
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: argocd-server
            port:
              number: 80
```

-   **`auth-url`**: `argocd.private.sigee.xyz`ë¡œ ë“¤ì–´ì˜¨ ëª¨ë“  ìš”ì²­ì€ ë¨¼ì € `Nginx Ingress Controller`ì— ì˜í•´ `oauth2-proxy`ì˜ `/oauth2/auth` ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³´ë‚´ì§„ë‹¤. `oauth2-proxy`ëŠ” ìš”ì²­ í—¤ë”ì˜ ì¿ í‚¤ë¥¼ ê²€ì‚¬í•˜ì—¬ ìœ íš¨í•œ ì„¸ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
-   **`auth-signin`**: ë§Œì•½ ìœ íš¨í•œ ì„¸ì…˜ì´ ì—†ë‹¤ë©´, `oauth2-proxy`ëŠ” `401 Unauthorized` ì‘ë‹µì„ ë°˜í™˜í•˜ê³ , `Ingress Controller`ëŠ” ì‚¬ìš©ìë¥¼ `auth-signin`ì— ëª…ì‹œëœ URLë¡œ ë¦¬ë””ë ‰ì…˜ì‹œí‚¨ë‹¤. ì´ URLì€ `Keycloak` ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì—°ê²°ë˜ì–´ ì¸ì¦ì„ ìˆ˜í–‰í•˜ê²Œ ëœë‹¤.

ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì¸ `Grafana`(`monitor.private.sigee.xyz`)ë¥¼ í¬í•¨í•œ ë‹¤ë¥¸ ëª¨ë“  ë‚´ë¶€ ì„œë¹„ìŠ¤ì˜ `Ingress`ì—ë„ ìœ„ì™€ ë™ì¼í•œ ì–´ë…¸í…Œì´ì…˜ì„ ì ìš©í•˜ì—¬ ì¤‘ì•™ ì¸ì¦ ì‹œìŠ¤í…œì˜ ë³´í˜¸ë¥¼ ë°›ë„ë¡ ì„¤ì •í–ˆë‹¤.

## ê²°ê³¼ í™•ì¸

ì´ì œ ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆë‹¤. `argocd.private.sigee.xyz`ë‚˜ `monitor.private.sigee.xyz` ê°™ì€ ë‚´ë¶€ ì„œë¹„ìŠ¤ì— ì ‘ì†ì„ ì‹œë„í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ `Keycloak` ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜ëœë‹¤.

![Keycloak ë¡œê·¸ì¸ í˜ì´ì§€](./images/keycloak-login.png)
*ë‚´ë¶€ ì„œë¹„ìŠ¤ ì ‘ê·¼ ì‹œ ë‚˜íƒ€ë‚˜ëŠ” Keycloak ë¡œê·¸ì¸ í™”ë©´*

ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ ì›ë˜ ì ‘ì†í•˜ë ¤ë˜ ì„œë¹„ìŠ¤ë¡œ ì •ìƒì ìœ¼ë¡œ ì´ë™í•˜ê²Œ ëœë‹¤.

ì´ë ‡ê²Œ Keycloak ì¸ì¦ì„ ê±°ì¹˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ ArgoCDì™€ Grafana ì„œë¹„ìŠ¤ì— ì•ˆì „í•˜ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

![ArgoCD ë¡œê·¸ì¸](./images/argocd-login.png)
*Keycloak ì¸ì¦ í›„ ArgoCD ì ‘ì† í™”ë©´*

![Grafana ë¡œê·¸ì¸](./images/grafana-login.png)
*Keycloak ì¸ì¦ í›„ Grafana ì ‘ì† í™”ë©´*

ë§Œì•½ `Keycloak`ì˜ `/developers` ê·¸ë£¹ì— ì†í•˜ì§€ ì•Šì€ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ì„ ì‹œë„í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ `403 Forbidden` ì—ëŸ¬ í˜ì´ì§€ê°€ ë‚˜íƒ€ë‚˜ ì ‘ê·¼ì´ ì°¨ë‹¨ëœë‹¤.

![403 Forbidden ì—ëŸ¬](./images/oauth2-proxy-login-authorization-403.png)
*ì¸ê°€ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì˜ ì ‘ê·¼ ì‹œë„*

## ê²°ë¡ 

ì´ëŸ¬í•œ êµ¬ì„±ì„ í†µí•´ `VPN`ì´ë‚˜ ë³µì¡í•œ IP ê·œì¹™ ê´€ë¦¬ ì—†ì´ë„, `Keycloak` ê³„ì •ë§Œ ìˆìœ¼ë©´ ì–´ë””ì„œë“  ì•ˆì „í•˜ê²Œ ë‚´ë¶€ ê´€ë¦¬ ë„êµ¬ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆì—ˆë‹¤. ëª¨ë“  ë‚´ë¶€ ì„œë¹„ìŠ¤ëŠ” `HTTPS`ë¡œ í†µì‹ í•˜ë©°, `Keycloak`ì˜ `/developers` ê·¸ë£¹ì— ì†í•œ ì¸ê°€ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.

ì´ì œ ìƒˆë¡œìš´ ê°œë°œ ë™ë£Œê°€ í•©ë¥˜í•˜ë©´ `Keycloak`ì—ì„œ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ ê°„ë‹¨íˆ ì¸í”„ë¼ ì ‘ê·¼ ì œì–´ê°€ ê°€ëŠ¥í•´ì¡Œë‹¤. ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ë¥¼ ì¶”ê°€í•  ë•Œ ì•½ê°„ì˜ ë²ˆê±°ë¡œì›€ì€ ìˆì§€ë§Œ, ì¶©ë¶„íˆ ê°ìˆ˜í•  ë§Œí•œ ê´€ë¦¬ ë¹„ìš©ì´ë¼ê³  ìƒê°í•œë‹¤.

ì‚¬ì‹¤ ë§ ê´€ë¦¬ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ë¥¼ ê²©ë¦¬í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•˜ê² ì§€ë§Œ, ë‚˜ì˜ íŠ¹ìˆ˜í•œ í™˜ê²½ì´ ì´ë¥¼ í—ˆë½í•˜ì§€ ì•Šì•˜ë‹¤. í•˜ì§€ë§Œ ê·¸ ë•ë¶„ì— `OIDC`ë¥¼ ê¹Šê²Œ íƒêµ¬í•˜ë©° ì´ë ‡ê²Œ ì¬ë¯¸ìˆëŠ” ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì„±í•´ë³¼ ìˆ˜ ìˆì—ˆë˜ ê²ƒ ê°™ë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ì¸í”„ë¼ì— ëŒ€í•œ ê³ ë¯¼ì„ ëœê³ , ë³¸ë˜ ëª©í‘œì˜€ë˜ í”„ë¡œì íŠ¸ ê°œë°œì— ë”ìš± ì§‘ì¤‘í•  ìˆ˜ ìˆëŠ” ê¸°ë°˜ì„ ë§ˆë ¨í•˜ê²Œ ë˜ì—ˆë‹¤.
